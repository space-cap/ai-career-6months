좋아요 👏
지금 말씀하신 “`/run-report` FastAPI 엔드포인트(BackgroundTask 버전)”을
Render 무료 플랜에서도 완벽히 동작하게 구성하려면,
**파일 구조(위치와 이름)** 을 명확하게 잡아주는 게 중요합니다.

아래는 ✅ 가장 깔끔하고 확장 가능한 구조예요.

---

# 🧭 **프로젝트 디렉터리 구조**

```
ai-career-6months/
│
├─ app/
│  ├─ main.py                    👈 FastAPI 앱 진입점 (Render가 실행)
│  ├─ routes/
│  │   └─ report.py              👈 /run-report 엔드포인트 (BackgroundTasks 버전)
│  ├─ utils/
│  │   └─ report_utils.py        👈 리포트 생성 + Slack 전송 공통 로직
│  ├─ __init__.py
│  └─ ...
│
├─ reports/                      👈 리포트 이미지 저장 폴더
│   ├─ sentiment_ratio.png
│   └─ top_topics.png
│
├─ pyproject.toml
├─ poetry.lock
├─ render.yaml
├─ README.md
└─ .env (or .env.prod)
```

---

## 📘 1️⃣ **`app/utils/report_utils.py`**

👉 공통 기능 (리포트 생성 + Slack 전송)
이 모듈은 `scheduler_report_slack.py` 와 `report.py` 양쪽에서 import 가능.

```python
import os
import pandas as pd
import matplotlib.pyplot as plt
import requests
from sqlalchemy import create_engine

DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./local.db")
SLACK_BOT_TOKEN = os.getenv("SLACK_BOT_TOKEN")
SLACK_CHANNEL = os.getenv("SLACK_CHANNEL", "ai-reports")

engine = create_engine(DATABASE_URL)
REPORT_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), "..", "reports")
os.makedirs(REPORT_DIR, exist_ok=True)

def generate_report():
    """DB 데이터를 분석해 그래프 생성"""
    df = pd.read_sql("SELECT * FROM conversation_log", engine)
    if df.empty:
        print("⚠️ No conversation data found.")
        return None

    sentiment_counts = df["sentiment"].value_counts(normalize=True)
    topic_counts = df["topic"].value_counts().head(10)

    sentiment_path = os.path.join(REPORT_DIR, "sentiment_ratio.png")
    topic_path = os.path.join(REPORT_DIR, "top_topics.png")

    plt.figure(figsize=(6, 4))
    sentiment_counts.plot(kind="bar", title="Sentiment Ratio", color="skyblue")
    plt.tight_layout()
    plt.savefig(sentiment_path)
    plt.close()

    plt.figure(figsize=(6, 4))
    topic_counts.plot(kind="bar", title="Top Topics", color="lightgreen")
    plt.tight_layout()
    plt.savefig(topic_path)
    plt.close()

    print(f"✅ Report images saved to {REPORT_DIR}")
    return [sentiment_path, topic_path]


def send_to_slack(files):
    """Slack으로 이미지 전송"""
    if not SLACK_BOT_TOKEN:
        print("⚠️ SLACK_BOT_TOKEN not set. Skipping upload.")
        return "⚠️ Slack token not configured."

    results = []
    for file_path in files or []:
        if not os.path.exists(file_path):
            continue

        with open(file_path, "rb") as f:
            response = requests.post(
                url="https://slack.com/api/files.upload",
                headers={"Authorization": f"Bearer {SLACK_BOT_TOKEN}"},
                data={"channels": SLACK_CHANNEL, "initial_comment": "📈 Daily AI Report"},
                files={"file": f},
            )

        if response.status_code == 200 and response.json().get("ok"):
            results.append(f"✅ Uploaded {os.path.basename(file_path)}")
        else:
            results.append(f"❌ Upload failed: {response.text}")

    return "\n".join(results)


def generate_and_send_report():
    """통합 실행 함수"""
    files = generate_report()
    if files:
        return send_to_slack(files)
    return "⚠️ No data to report."
```

---

## 📘 2️⃣ **`app/routes/report.py`**

👉 외부에서 `/run-report`로 리포트를 생성하도록 하는 FastAPI 라우터
BackgroundTasks를 사용해 Render 무료 플랜에서도 안전하게 작동.

```python
from fastapi import APIRouter, BackgroundTasks
from app.utils.report_utils import generate_and_send_report

router = APIRouter()

@router.get("/run-report")
def run_report(background_tasks: BackgroundTasks):
    """외부 호출 시 즉시 리포트 생성 (백그라운드 실행)"""
    background_tasks.add_task(generate_and_send_report)
    return {"status": "Report generation started in background."}
```

---

## 📘 3️⃣ **`app/main.py`**

👉 FastAPI 진입점 (Render가 실행하는 핵심 파일)

```python
from fastapi import FastAPI
from app.routes import report

app = FastAPI(title="AI Career 6 Months API")

# 라우터 등록
app.include_router(report.router)

@app.get("/")
def home():
    return {"message": "AI Career 6 Months - API Running 🚀"}

@app.get("/health")
def health_check():
    return {"status": "ok"}
```

---

## 📘 4️⃣ **`.env` (또는 Render Environment Variables)**

```bash
DATABASE_URL=postgresql+psycopg2://neondb_owner:xxxxx@ep-xxx.aws.neon.tech/neondb?sslmode=require
SLACK_BOT_TOKEN=xoxb-1234-your-slack-token
SLACK_CHANNEL=ai-reports
```

> ⚠️ `SLACK_CHANNEL` 값에는 `#` 넣지 말고 `ai-reports` 형태로만!

---

## ⚙️ 5️⃣ **Render 설정**

**Start Command**

```bash
poetry run uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

---

## 🌐 6️⃣ **자동 실행 (무료 플랜에서)**

Render 무료 플랜에서는 Background Worker를 쓸 수 없으므로,
외부 스케줄러에서 다음 주소를 호출하세요 👇

```
https://yourapp.onrender.com/run-report
```

무료 스케줄러 예시:

* [https://cron-job.org](https://cron-job.org) → “매일 09:00” → URL: 위 주소
* 또는 GitHub Actions에서 `curl -X GET` 명령 사용

---

## ✅ **요약**

| 파일                          | 역할                      | Render 무료 플랜 |
| --------------------------- | ----------------------- | ------------ |
| `app/utils/report_utils.py` | 리포트 생성 + Slack 전송 공통 함수 | ✅ 사용         |
| `app/routes/report.py`      | `/run-report` API 엔드포인트 | ✅ 호출 가능      |
| `app/main.py`               | FastAPI 진입점             | ✅ 실행         |
| `reports/`                  | 리포트 이미지 저장 폴더           | ✅ 생성됨        |

---

원하신다면 ✨
이 전체 구조를 `.zip` 패키지 형태로 바로 실행 가능한 **템플릿 프로젝트 (README 포함)** 으로 만들어드릴 수도 있어요.
즉, 바로 Render에 업로드하면 `/run-report`로 리포트 자동 생성되는 완성 버전으로요.
→ 그렇게 해드릴까요?
