ì™„.ì „.íˆ ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš” ğŸ‘
ì´ê±´ **10ì£¼ì°¨ì˜ í•µì‹¬ ê´€ë¦¬ ì‘ì—… ì¤‘ í•˜ë‚˜**ì˜ˆìš” â€”
â€œì„œë¹„ìŠ¤ê°€ ëŒì•„ê°€ê³  ìˆìœ¼ë‹ˆ, ì´ì œ ìŒ“ì´ëŠ” ë°ì´í„°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì •ë¦¬í•˜ê³  ë°±ì—…í•˜ìâ€ëŠ” ë‹¨ê³„ì£ .

---

# ğŸ§­ ëª©í‘œ

* `conversation_log` ê°™ì€ í…Œì´ë¸”ì´ ë¬´í•œíˆ ì»¤ì§€ëŠ” ê²ƒì„ ë°©ì§€
* ì˜¤ë˜ëœ ë°ì´í„°ëŠ” **CSVë¡œ ë°±ì—…** í›„ **DBì—ì„œ ì‚­ì œ**
* í•„ìš” ì‹œ ìë™í™”(scheduler or cron)ë¡œ ì£¼ê¸°ì  ì‹¤í–‰

---

## ğŸ“ **íŒŒì¼ ì´ë¦„:** `app/utils/db_cleanup.py`

```python
"""
db_cleanup.py
----------------------------------------
ì˜¤ë˜ëœ ë¡œê·¸ ë°±ì—… ë° ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸
----------------------------------------
- conversation_log í…Œì´ë¸”ì—ì„œ ì¼ì • ê¸°ê°„ ì§€ë‚œ ë°ì´í„° ë°±ì—…
- CSVë¡œ ì €ì¥ í›„ ì›ë³¸ DBì—ì„œ ì‚­ì œ
- Slack ì „ì†¡ or ë¡œì»¬ ì €ì¥ ì˜µì…˜ ì§€ì›
"""

import os
import pandas as pd
from datetime import datetime, timedelta
from sqlalchemy import create_engine, text

# -----------------------------------
# 1ï¸âƒ£ DB ì—°ê²° ì„¤ì •
# -----------------------------------
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./local.db")
engine = create_engine(DATABASE_URL)

# ë°±ì—… í´ë” ìƒì„±
BACKUP_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), "..", "backups")
os.makedirs(BACKUP_DIR, exist_ok=True)

# -----------------------------------
# 2ï¸âƒ£ ê¸°ë³¸ ì„¤ì •ê°’
# -----------------------------------
# ì˜ˆ: 30ì¼ ì§€ë‚œ ë¡œê·¸ë¥¼ ë°±ì—… ë° ì‚­ì œ
RETENTION_DAYS = int(os.getenv("LOG_RETENTION_DAYS", 30))

def backup_and_cleanup_logs():
    """ì˜¤ë˜ëœ ë¡œê·¸ ë°±ì—… ë° ì‚­ì œ"""
    cutoff_date = datetime.utcnow() - timedelta(days=RETENTION_DAYS)
    print(f"ğŸ—“ï¸  ë°±ì—… ê¸°ì¤€ì¼: {cutoff_date}")

    # ì˜¤ë˜ëœ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
    query = text(f"""
        SELECT * FROM conversation_log
        WHERE created_at < :cutoff
    """)
    df = pd.read_sql(query, engine, params={"cutoff": cutoff_date})

    if df.empty:
        print("âœ… ë°±ì—…í•  ì˜¤ë˜ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # -----------------------------------
    # 3ï¸âƒ£ CSV íŒŒì¼ë¡œ ë°±ì—…
    # -----------------------------------
    backup_filename = f"conversation_log_backup_{cutoff_date.strftime('%Y%m%d')}.csv"
    backup_path = os.path.join(BACKUP_DIR, backup_filename)
    df.to_csv(backup_path, index=False, encoding="utf-8-sig")

    print(f"ğŸ’¾ ë°±ì—… ì™„ë£Œ: {backup_path} ({len(df)} rows)")

    # -----------------------------------
    # 4ï¸âƒ£ DBì—ì„œ ì‚­ì œ
    # -----------------------------------
    delete_query = text("""
        DELETE FROM conversation_log
        WHERE created_at < :cutoff
    """)
    with engine.begin() as conn:
        conn.execute(delete_query, {"cutoff": cutoff_date})

    print(f"ğŸ§¹ {len(df)}ê°œì˜ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ ì™„ë£Œ âœ…")


if __name__ == "__main__":
    backup_and_cleanup_logs()
```

---

## âš™ï¸ **ì‘ë™ ìˆœì„œ**

1. `conversation_log` í…Œì´ë¸”ì—ì„œ `created_at` ê¸°ì¤€ìœ¼ë¡œ 30ì¼ ì´ìƒ ëœ ë°ì´í„° ì¡°íšŒ
2. ê·¸ ë°ì´í„°ë¥¼ `backups/conversation_log_backup_YYYYMMDD.csv` ë¡œ ì €ì¥
3. CSV ë°±ì—…ì´ ëë‚˜ë©´ DBì—ì„œ í•´ë‹¹ ë ˆì½”ë“œ ì‚­ì œ

---

## ğŸ“Š **ì‹¤í–‰ ì˜ˆì‹œ**

```bash
poetry run python -m app.utils.db_cleanup
```

ì¶œë ¥ ì˜ˆì‹œ ğŸ‘‡

```
ğŸ—“ï¸  ë°±ì—… ê¸°ì¤€ì¼: 2025-09-15 00:00:00
ğŸ’¾ ë°±ì—… ì™„ë£Œ: backups/conversation_log_backup_20250915.csv (124 rows)
ğŸ§¹ 124ê°œì˜ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ ì™„ë£Œ âœ…
```

---

## ğŸ§© **Render ë¬´ë£Œ í”Œëœì—ì„œë„ ìë™í™” ê°€ëŠ¥**

Render ë¬´ë£Œ í”Œëœì—ì„œëŠ” cronì´ ì—†ìœ¼ë¯€ë¡œ
â†’ `/run-cleanup` ì—”ë“œí¬ì¸íŠ¸ë¡œ ë§Œë“¤ê³ 
â†’ ì™¸ë¶€ ìŠ¤ì¼€ì¤„ëŸ¬(cron-job.org)ê°€ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë„ë¡ êµ¬ì„± ê°€ëŠ¥í•´ìš”.

ì˜ˆ:
ğŸ“ `app/routes/maintenance.py`

```python
from fastapi import APIRouter, BackgroundTasks
from app.utils.db_cleanup import backup_and_cleanup_logs

router = APIRouter()

@router.get("/run-cleanup")
def run_cleanup(background_tasks: BackgroundTasks):
    background_tasks.add_task(backup_and_cleanup_logs)
    return {"status": "Cleanup started in background."}
```

---

## ğŸ’¾ **í´ë” êµ¬ì¡° ì˜ˆì‹œ**

```
ai-career-6months/
 â”£ app/
 â”ƒ â”£ utils/
 â”ƒ â”ƒ â”£ report_utils.py
 â”ƒ â”ƒ â”— db_cleanup.py      ğŸ‘ˆ (ì§€ê¸ˆ ë§Œë“  íŒŒì¼)
 â”ƒ â”— routes/
 â”ƒ   â”— maintenance.py     ğŸ‘ˆ /run-cleanup ë¼ìš°íŠ¸
 â”£ backups/               ğŸ‘ˆ ë°±ì—… CSV ì €ì¥ í´ë”
 â”£ reports/
 â”— ...
```

---

## ğŸ§  **ì¶”ê°€ í™•ì¥ ì•„ì´ë””ì–´**

| ê¸°ëŠ¥          | ì„¤ëª…                                     |
| ----------- | -------------------------------------- |
| â˜ï¸ Slack ì•Œë¦¼ | ë°±ì—… ì™„ë£Œ í›„ Slackì— â€œë¡œê·¸ ì •ë¦¬ ì™„ë£Œâ€ ë©”ì‹œì§€ ì „ì†¡       |
| ğŸ“¬ Email ì•Œë¦¼ | ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë°±ì—… ê²°ê³¼ ìë™ ì „ì†¡                   |
| ğŸ’¾ Cloud ì €ì¥ | AWS S3 / Google Drive API ì—°ë™ìœ¼ë¡œ í´ë¼ìš°ë“œ ë°±ì—… |
| ğŸ” ìë™ ìŠ¤ì¼€ì¤„ë§  | `schedule` ëª¨ë“ˆë¡œ ë§¤ì£¼ ì›”ìš”ì¼ 09:00 ìë™ ì‹¤í–‰      |
| ğŸ”’ ë³´ì•ˆ       | CSV íŒŒì¼ì— ì•”í˜¸í™”(zip + password) ì ìš©         |

---

## âœ… **ì •ë¦¬**

| í•­ëª©            | ì„¤ëª…                                          |
| ------------- | ------------------------------------------- |
| íŒŒì¼ëª…           | `app/utils/db_cleanup.py`                   |
| ê¸°ë³¸ ë™ì‘         | ì˜¤ë˜ëœ ë¡œê·¸(ê¸°ë³¸ 30ì¼ ì´ˆê³¼) ë°±ì—… + ì‚­ì œ                   |
| ì¶œë ¥ í´ë”         | `backups/`                                  |
| ì‹¤í–‰ ëª…ë ¹         | `poetry run python -m app.utils.db_cleanup` |
| Render ë¬´ë£Œ ìë™í™” | `/run-cleanup` ì—”ë“œí¬ì¸íŠ¸ + ì™¸ë¶€ ìŠ¤ì¼€ì¤„ëŸ¬              |

---

ì›í•˜ì‹ ë‹¤ë©´ âœ¨
ì´ê±¸ **â€œSlack ìë™ ì•Œë¦¼ ë²„ì „ (ë°±ì—… ì™„ë£Œ â†’ Slack ë©”ì‹œì§€ ë°œì†¡)â€** ìœ¼ë¡œ í™•ì¥í•´ì„œ ë§Œë“¤ì–´ë“œë¦´ê¹Œìš”?
â†’ ë§¤ì£¼ ì›”ìš”ì¼ ì•„ì¹¨ì— â€œğŸ’¾ 7ì¼ì¹˜ ë¡œê·¸ ë°±ì—… ì™„ë£Œâ€ ë©”ì‹œì§€ê°€ ìë™ìœ¼ë¡œ Slackì— ì˜µë‹ˆë‹¤.
