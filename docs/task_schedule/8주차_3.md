좋아요 🔥
이건 진짜 중요한 단계예요.
배포 전에는 꼭 “모든 연결이 제대로 되어 있는지” 확인해야 하거든요.
지금 만들어드릴 **`deploy_check.py`** 스크립트는 Render 배포 직전에 실행하면
👇 아래 5가지를 자동으로 점검합니다.

---

## ✅ **점검 항목**

| 항목  | 내용                                   |
| --- | ------------------------------------ |
| 1️⃣ | `.env` 환경 파일 로드 (local / prod 자동 감지) |
| 2️⃣ | `DATABASE_URL` 유효성 검사                |
| 3️⃣ | PostgreSQL (Neon) 연결 테스트             |
| 4️⃣ | OpenAI API Key 유효성 테스트               |
| 5️⃣ | Chroma DB 폴더 접근성 확인                  |

---

## 📁 **파일: `deploy_check.py`**

```python
"""
deploy_check.py
-----------------
Render 배포 전 필수 점검 스크립트.
✅ DB 연결 / OpenAI Key / Chroma 경로 / 환경 설정 등을 자동 검증합니다.
"""

import os
import sys
import psycopg2
from dotenv import load_dotenv
from openai import OpenAI
from pathlib import Path

# -------------------------------
# 1️⃣ 환경 파일 자동 감지
# -------------------------------
env_mode = os.getenv("ENV", "local")
env_file = ".env.prod" if env_mode == "production" else ".env.local"

if not Path(env_file).exists():
    print(f"❌ 환경 파일({env_file})을 찾을 수 없습니다.")
    sys.exit(1)

load_dotenv(env_file)
print(f"✅ 환경 파일 로드 완료: {env_file}")

# -------------------------------
# 2️⃣ 환경 변수 확인
# -------------------------------
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
DATABASE_URL = os.getenv("DATABASE_URL")
CHROMA_PATH = os.getenv("CHROMA_PATH")

if not OPENAI_API_KEY:
    print("❌ OPENAI_API_KEY 누락됨")
else:
    print("✅ OPENAI_API_KEY 존재함")

if not DATABASE_URL:
    print("❌ DATABASE_URL 누락됨")
    sys.exit(1)
else:
    print("✅ DATABASE_URL 확인됨")

# -------------------------------
# 3️⃣ DB 연결 테스트 (Neon PostgreSQL)
# -------------------------------
print("\n🔗 PostgreSQL 연결 테스트 중...")
try:
    conn = psycopg2.connect(DATABASE_URL)
    cur = conn.cursor()
    cur.execute("SELECT NOW();")
    now = cur.fetchone()[0]
    print(f"✅ DB 연결 성공 (서버 시간: {now})")
    cur.close()
    conn.close()
except Exception as e:
    print("❌ DB 연결 실패:")
    print(e)
    sys.exit(1)

# -------------------------------
# 4️⃣ OpenAI Key 테스트
# -------------------------------
print("\n🤖 OpenAI Key 테스트 중...")
try:
    client = OpenAI(api_key=OPENAI_API_KEY)
    response = client.models.list()
    model_count = len(response.data)
    print(f"✅ OpenAI Key 유효함 (모델 {model_count}개 확인)")
except Exception as e:
    print("❌ OpenAI API 테스트 실패:")
    print(e)
    sys.exit(1)

# -------------------------------
# 5️⃣ Chroma 경로 점검
# -------------------------------
print("\n🧠 Chroma 벡터스토어 경로 점검 중...")
if CHROMA_PATH:
    path = Path(CHROMA_PATH)
    if not path.exists():
        print(f"⚠️ Chroma 폴더가 존재하지 않아 새로 생성함: {path}")
        path.mkdir(parents=True, exist_ok=True)
    else:
        print(f"✅ Chroma 폴더 존재: {path.resolve()}")
else:
    print("⚠️ CHROMA_PATH 설정 없음 (환경파일 확인 필요)")

print("\n🎯 모든 점검 완료 — Ready for Deploy 🚀")
```

---

## ⚙️ **사용법**

```bash
# 로컬 테스트
python deploy_check.py

# 또는 Poetry 환경에서
poetry run python deploy_check.py
```

---

## 🧾 **실행 예시 (성공 시 출력)**

```bash
✅ 환경 파일 로드 완료: .env.prod
✅ OPENAI_API_KEY 존재함
✅ DATABASE_URL 확인됨

🔗 PostgreSQL 연결 테스트 중...
✅ DB 연결 성공 (서버 시간: 2025-10-14 12:21:09.430182+00)

🤖 OpenAI Key 테스트 중...
✅ OpenAI Key 유효함 (모델 64개 확인)

🧠 Chroma 벡터스토어 경로 점검 중...
✅ Chroma 폴더 존재: /opt/render/project/src/chroma_db

🎯 모든 점검 완료 — Ready for Deploy 🚀
```

---

## ❌ **실패 시 예시**

```bash
❌ DB 연결 실패:
psycopg2.OperationalError: could not connect to server: Connection refused
```

또는

```bash
❌ OPENAI_API_KEY 누락됨
❌ OpenAI API 테스트 실패: AuthenticationError: No API key provided
```

→ 이렇게 오류가 출력되면, Render 환경변수 설정을 다시 확인하세요.

---

## 💡 **Render에 배포하기 전 체크 포인트**

| 항목             | 확인 방법                        | 정상 상태 |
| -------------- | ---------------------------- | ----- |
| `.env.prod`    | `deploy_check.py`에서 자동 로드    | ✅     |
| DATABASE_URL   | Neon PostgreSQL SSL 포함       | ✅     |
| DB 연결          | psycopg2로 SELECT NOW()       | ✅     |
| OPENAI_API_KEY | `client.models.list()` 호출 성공 | ✅     |
| CHROMA_PATH    | 경로 생성 확인                     | ✅     |

---

이제 이 스크립트를 `ai-career-6months/` 루트에 넣고
배포 전에 한 번 실행만 해보면
👉 “DB 연결 / OpenAI Key / 벡터스토어 경로”
모두 문제없는 상태에서 Render에 올릴 수 있습니다 💪

---

원하신다면 이 `deploy_check.py`에
🧩 “Chroma 컬렉션 개수 점검”이나
🧠 “SQLAlchemy ORM 테스트 쿼리” (예: ConversationLog 존재 여부)
까지 확장한 버전도 만들어드릴까요?
→ 완전한 **“Deploy Preflight Check Pro 버전”** 🚀
