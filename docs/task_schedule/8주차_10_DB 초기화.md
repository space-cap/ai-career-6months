좋아요 👍
아래는 **로컬(SQLite)** 과 **Render/Neon(PostgreSQL)** 양쪽에서 모두 동작하는
완전한 버전의 `init_db.py` 입니다.

이 스크립트는 FastAPI 서버를 실행하지 않고도
명령 한 줄로 **DB 테이블(`conversation_log`)을 자동 생성**할 수 있도록 만들어졌어요.

---

# 📁 `app/init_db.py`

```python
"""
init_db.py
------------------------------------------
AI Career 6 Months 프로젝트용 DB 초기화 스크립트

✅ 기능:
  - DATABASE_URL(.env 또는 Render 환경변수) 자동 로드
  - SQLAlchemy Base 모델 기반 테이블 자동 생성
  - 로컬(SQLite) 또는 Render/Neon(PostgreSQL) 모두 지원
  - 현재 연결된 DB URL과 테이블 목록 출력

실행:
  poetry run python app/init_db.py
------------------------------------------
"""

import os
import sys
from sqlalchemy import create_engine, inspect
from sqlalchemy.exc import SQLAlchemyError
from app.models import Base

# ------------------------------------------
# 1️⃣ 환경 변수 로드 (.env.local 또는 .env.prod)
# ------------------------------------------
from dotenv import load_dotenv

# 우선순위: .env.prod → .env.local
if os.path.exists(".env.prod"):
    load_dotenv(".env.prod")
elif os.path.exists(".env.local"):
    load_dotenv(".env.local")

# ------------------------------------------
# 2️⃣ DATABASE_URL 가져오기
# ------------------------------------------
DATABASE_URL = os.getenv("DATABASE_URL")

if not DATABASE_URL:
    print("❌ ERROR: DATABASE_URL이 설정되어 있지 않습니다.")
    print("👉 .env.local 또는 .env.prod 파일을 확인하세요.")
    sys.exit(1)

print(f"🔗 Connecting to database: {DATABASE_URL}")

# ------------------------------------------
# 3️⃣ DB 엔진 생성
# ------------------------------------------
try:
    engine = create_engine(DATABASE_URL, pool_pre_ping=True)
except Exception as e:
    print(f"❌ 데이터베이스 엔진 생성 실패: {e}")
    sys.exit(1)

# ------------------------------------------
# 4️⃣ 테이블 생성
# ------------------------------------------
try:
    Base.metadata.create_all(bind=engine)
    print("✅ 모든 테이블이 성공적으로 생성되었습니다.")
except SQLAlchemyError as e:
    print(f"❌ 테이블 생성 중 오류 발생: {e}")
    sys.exit(1)

# ------------------------------------------
# 5️⃣ 생성된 테이블 목록 출력
# ------------------------------------------
try:
    inspector = inspect(engine)
    tables = inspector.get_table_names()
    if tables:
        print("📋 생성된 테이블 목록:")
        for t in tables:
            print(f"   • {t}")
    else:
        print("⚠️ 생성된 테이블이 없습니다.")
except Exception as e:
    print(f"⚠️ 테이블 확인 중 오류: {e}")

print("🎉 DB 초기화가 완료되었습니다.")
```

---

# 📁 `app/models.py` (참고용 — 혹시 없다면 추가)

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, func
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class ConversationLog(Base):
    __tablename__ = "conversation_log"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(50))
    question = Column(Text)
    answer = Column(Text)
    sentiment = Column(String(20))
    topic = Column(String(50))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

---

# ✅ 실행 방법

### 🧩 로컬 개발환경

```bash
poetry run python app/init_db.py
```

→ `.env.local` 의 `DATABASE_URL` (ex: sqlite:///./local.db)을 기준으로 DB 생성

---

### 🌍 Render / Neon 배포환경 (테스트용)

```bash
DATABASE_URL="postgresql+psycopg2://neondb_owner:xxxxx@ep-smooth-water-xxx.aws.neon.tech/neondb?sslmode=require" poetry run python app/init_db.py
```

→ `.env.prod` 없이도 직접 실행 가능

---

# 🔍 실행 결과 예시

```
🔗 Connecting to database: postgresql+psycopg2://neondb_owner@ep-smooth-water.../neondb?sslmode=require
✅ 모든 테이블이 성공적으로 생성되었습니다.
📋 생성된 테이블 목록:
   • conversation_log
🎉 DB 초기화가 완료되었습니다.
```

---

# 💡 추가 팁

| 환경     | 파일                                 | 설명                        |
| ------ | ---------------------------------- | ------------------------- |
| 로컬     | `.env.local`                       | SQLite or Local Neon 테스트용 |
| Render | `.env.prod`                        | 배포용 PostgreSQL URL        |
| 명령어    | `poetry run python app/init_db.py` | 언제든 초기화 가능                |
| 실행 위치  | 프로젝트 루트 (`ai-career-6months/`)     | ✅ 반드시 루트에서 실행             |

---

원하신다면 💾
이 스크립트가 **FastAPI 서버 시작 시 자동 실행되도록 (`on_startup` 이벤트에 연결)** 하는 버전도 만들어드릴까요?
→ 배포 시 자동으로 Neon DB 초기화까지 수행되게 됩니다.
