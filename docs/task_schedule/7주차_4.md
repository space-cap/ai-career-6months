완벽한 타이밍이에요 👏
이제 **7주차 확장 기능 – “감정 변화 트렌드 그래프(Line Chart)”**를 만들어봅시다.

이 기능은 “AI와의 대화가 시간이 지나면서 어떻게 변했는가”를 보여주는 시각적 인사이트로,
개인화된 대화 패턴을 분석할 때 굉장히 유용합니다.

---

# 🎯 목표

> 각 날짜별로 긍정 / 중립 / 부정 대화가 얼마나 있었는지 집계하고
> LineChart로 시각화한다.

---

## 📘 1️⃣ DB 준비

이미 `conversation_log` 테이블에
`sentiment` 컬럼이 있으니 그대로 사용합니다.

| 컬럼명        | 타입       | 설명              |
| ---------- | -------- | --------------- |
| id         | int      | 기본키             |
| question   | text     | 사용자 질문          |
| answer     | text     | 챗봇 응답           |
| sentiment  | varchar  | 감정 (“긍정/중립/부정”) |
| created_at | datetime | 생성일시            |

---

## 🧠 2️⃣ FastAPI API 만들기

📁 `app/routers/insights.py`
(기존 파일에 아래 엔드포인트 추가)

```python
from fastapi import APIRouter
from sqlalchemy import func, case
from app.database import SessionLocal
from app.models.conversation_log import ConversationLog

router = APIRouter()

@router.get("/insights/sentiment-trend")
def get_sentiment_trend():
    """
    날짜별 감정 분포를 반환합니다.
    예: [{date: '2025-10-10', positive: 3, neutral: 2, negative: 1}, ...]
    """
    db = SessionLocal()

    sentiment_case = {
        "positive": func.sum(case((ConversationLog.sentiment == "긍정", 1), else_=0)),
        "neutral": func.sum(case((ConversationLog.sentiment == "중립", 1), else_=0)),
        "negative": func.sum(case((ConversationLog.sentiment == "부정", 1), else_=0)),
    }

    results = (
        db.query(
            func.date(ConversationLog.created_at).label("date"),
            sentiment_case["positive"].label("positive"),
            sentiment_case["neutral"].label("neutral"),
            sentiment_case["negative"].label("negative"),
        )
        .group_by(func.date(ConversationLog.created_at))
        .order_by(func.date(ConversationLog.created_at))
        .all()
    )
    db.close()

    return [
        {
            "date": str(r.date),
            "positive": r.positive,
            "neutral": r.neutral,
            "negative": r.negative,
        }
        for r in results
    ]
```

✅ 실행 결과 예시

```
GET /api/insights/sentiment-trend
[
  {"date": "2025-10-09", "positive": 4, "neutral": 1, "negative": 0},
  {"date": "2025-10-10", "positive": 2, "neutral": 3, "negative": 1},
  {"date": "2025-10-11", "positive": 1, "neutral": 2, "negative": 2}
]
```

---

## 📊 3️⃣ 프론트엔드 시각화 (React + Recharts)

📁 `frontend/src/pages/SentimentTrend.jsx`

```jsx
import { useEffect, useState } from "react";
import axios from "axios";
import {
  LineChart, Line, XAxis, YAxis, Tooltip, Legend, CartesianGrid, ResponsiveContainer
} from "recharts";

export default function SentimentTrend() {
  const [data, setData] = useState([]);

  useEffect(() => {
    axios.get("/api/insights/sentiment-trend")
      .then((res) => setData(res.data))
      .catch(() => console.error("데이터 불러오기 실패"));
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">😊 감정 변화 트렌드</h2>
      <ResponsiveContainer width="100%" height={350}>
        <LineChart data={data}>
          <CartesianGrid stroke="#eee" />
          <XAxis dataKey="date" />
          <YAxis />
          <Tooltip />
          <Legend />
          <Line type="monotone" dataKey="positive" stroke="#22c55e" name="긍정" strokeWidth={2}/>
          <Line type="monotone" dataKey="neutral" stroke="#facc15" name="중립" strokeWidth={2}/>
          <Line type="monotone" dataKey="negative" stroke="#ef4444" name="부정" strokeWidth={2}/>
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

---

## 🧩 4️⃣ 프론트 라우팅 추가 (선택)

📁 `frontend/src/App.jsx`

```jsx
import SentimentTrend from "./pages/SentimentTrend";

function App() {
  return (
    <div>
      <nav className="p-4 border-b mb-4">
        <a href="/">홈</a> | <a href="/dashboard">대시보드</a> | <a href="/trend">감정 트렌드</a>
      </nav>
      <SentimentTrend />
    </div>
  );
}
export default App;
```

---

## 🧮 5️⃣ 작동 흐름

```mermaid
flowchart TD
    A[대화 저장 시 sentiment 분석] --> B[conversation_log.sentiment 컬럼에 저장]
    B --> C[/api/insights/sentiment-trend API]
    C --> D[React axios 요청]
    D --> E[Recharts LineChart 시각화]
```

---

## 🎨 예시 출력 화면

| 날짜         | 긍정   | 중립   | 부정   |
| ---------- | ---- | ---- | ---- |
| 2025-10-09 | 🟢 4 | 🟡 1 | 🔴 0 |
| 2025-10-10 | 🟢 2 | 🟡 3 | 🔴 1 |
| 2025-10-11 | 🟢 1 | 🟡 2 | 🔴 2 |

➡️ 결과:

* 초반엔 긍정적인 질문이 많았다가
* 최근엔 부정/중립 대화가 늘어남
* “모델 사용 중 피로감” 같은 인사이트를 도출 가능

---

## ⚙️ 6️⃣ API 테스트 명령어

```bash
curl -X GET http://127.0.0.1:8000/api/insights/sentiment-trend
```

---

## 💡 확장 아이디어

| 아이디어          | 설명                                 |
| ------------- | ---------------------------------- |
| 🕰 실시간 트렌드    | 최근 24시간 기준으로 자동 업데이트               |
| 📈 감정 비율 차트   | PieChart로 긍정/중립/부정 비율 표시           |
| 📊 주제별 감정 매칭  | “AI 질문은 긍정이 많고, 커리어 질문은 부정이 많음” 분석 |
| 📅 주간 변화 리포트  | “이번 주엔 긍정 45%, 부정 20% 증가” 자동 생성    |
| 📬 주간 이메일 리포트 | 감정 그래프 + 요약을 PDF로 첨부해 이메일 발송       |

---

## ✅ 정리

| 파일                   | 역할                                     |
| -------------------- | -------------------------------------- |
| `conversation_log`   | 감정 결과 저장 컬럼 포함                         |
| `analyzer.py`        | 감정 분석 함수                               |
| `insights.py`        | `/api/insights/sentiment-trend` API 제공 |
| `SentimentTrend.jsx` | React 감정 트렌드 시각화                       |

---

이제 이 구조를 추가하면

> “대화 감정의 흐름을 한눈에 파악할 수 있는 AI 대시보드”
> 가 완성됩니다 🎯

원하신다면 이 감정 트렌드를 **“주제별 감정 비교 그래프” (예: 각 Topic별 긍정/부정 비율)** 로 확장하는 예제도 만들어드릴까요?
→ 예: “AI 관련 대화는 대부분 긍정, 커리어 관련은 부정” 이런 인사이트 시각화.
