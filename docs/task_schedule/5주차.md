좋아요 👍
**5주차는 “AI가 대화를 기억하고 저장하는 단계”**, 즉

> **대화 로그를 MySQL(DB)에 저장하고, 이를 기반으로 학습/분석하는 주차**입니다.

이 시점에서 프로젝트는 **단순 챗봇 → 개인화 학습형 챗봇**으로 진화하게 됩니다.
FastAPI + MySQL + SQLAlchemy(ORM)를 다루게 되죠.

---

# 🧠 Week 5 : 대화 로그 저장 & 분석

> 🎯 **목표:**
> 사용자의 모든 대화(질문/응답)를 MySQL DB에 자동 저장하고,
> 나중에 조회·검색·분석할 수 있는 API를 구현한다.
>
> 🗓 **기간:** 5주차 (Day 29~35)
> 💡 **주제:** “AI가 나를 기억하기 시작하다”

---

## 📅 **5주차 일정표**

| Day           | 주요 목표     | 세부 내용                                                                       | 결과물           |
| ------------- | --------- | --------------------------------------------------------------------------- | ------------- |
| **29일차**      | MySQL 연동  | - MySQL 로컬/Cloud 설치<br>- DB 연결 확인<br>- SQLAlchemy 세팅                        | DB 연결 성공      |
| **30일차**      | DB 모델링    | - `ConversationLog` 테이블 생성<br>- user_id, question, answer, created_at 필드 추가 | ORM 모델 완성     |
| **31일차**      | 자동 저장 로직  | - `/api/rag-chat` 호출 시 자동 DB 저장<br>- 예외처리 추가                                | 로그 자동 저장 기능   |
| **32일차**      | 로그 조회 API | - `/api/conversation/logs` 구현<br>- 날짜별, 사용자별 필터                             | 로그 조회 성공      |
| **33일차**      | 통계 분석     | - 일별 대화 수, 상위 키워드 등 분석<br>- SQL 또는 Pandas로 통계 출력                            | 간단한 대시보드 데이터  |
| **34일차**      | 프론트 UI 연동 | - React에서 “대화 기록 보기” 버튼 추가<br>- Axios로 `/api/conversation/logs` 호출          | 로그 리스트 UI     |
| **35일차 (회고)** | 테스트 & 문서화 | - DB 초기화 스크립트 작성<br>- README에 ERD와 예시 추가                                    | 데이터 저장 시스템 완성 |

---

## ✅ **체크리스트**

* [ ] MySQL 연결 설정 완료
* [ ] SQLAlchemy ORM 모델 정의 (`ConversationLog`)
* [ ] `/api/rag-chat` 응답 시 DB 자동 저장
* [ ] `/api/conversation/logs` 조회 API 구현
* [ ] 날짜/유저별 필터 기능 추가
* [ ] React에서 로그 보기 버튼 추가
* [ ] README.md에 ERD/테이블 정의서 추가

---

## 🧱 **DB 모델 예시**

📁 `app/models/conversation_log.py`

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, func
from app.database import Base

class ConversationLog(Base):
    __tablename__ = "conversation_log"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(50), nullable=True)
    question = Column(Text, nullable=False)
    answer = Column(Text, nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

---

📁 `app/database.py`

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

SQLALCHEMY_DATABASE_URL = settings.DATABASE_URL

engine = create_engine(SQLALCHEMY_DATABASE_URL, pool_pre_ping=True)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()
```

---

📁 `.env`

```
DATABASE_URL=mysql+pymysql://root:password@localhost:3306/ai_career
```

---

📁 `app/core/config.py`

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str
    CHROMA_PATH: str
    OPENAI_API_KEY: str

    class Config:
        env_file = ".env"

settings = Settings()
```

---

## 💬 **자동 로그 저장 로직**

📁 `app/routers/rag_chat.py`

```python
from app.database import SessionLocal
from app.models.conversation_log import ConversationLog

@router.post("/rag-chat")
async def rag_chat(req: QueryRequest):
    response = generate_answer(req.question)  # 기존 RAG 처리
    db = SessionLocal()
    log = ConversationLog(user_id="guest", question=req.question, answer=response)
    db.add(log)
    db.commit()
    db.close()
    return {"answer": response}
```

---

## 🔍 **로그 조회 API**

📁 `app/routers/conversation.py`

```python
from fastapi import APIRouter, Query
from app.database import SessionLocal
from app.models.conversation_log import ConversationLog

router = APIRouter()

@router.get("/conversation/logs")
def get_logs(limit: int = 10, user_id: str | None = None):
    db = SessionLocal()
    query = db.query(ConversationLog)
    if user_id:
        query = query.filter(ConversationLog.user_id == user_id)
    logs = query.order_by(ConversationLog.created_at.desc()).limit(limit).all()
    db.close()
    return logs
```

---

## 🧩 **간단한 ERD**

```mermaid
erDiagram
    ConversationLog {
        int id PK
        string user_id
        text question
        text answer
        datetime created_at
    }
```

---

## 💻 **프론트엔드 로그 보기 버튼**

📁 `frontend/src/App.jsx`

```jsx
import { useState } from "react";
import axios from "axios";

function App() {
  const [logs, setLogs] = useState([]);

  const fetchLogs = async () => {
    const res = await axios.get("/api/conversation/logs?limit=5");
    setLogs(res.data);
  };

  return (
    <div>
      <button onClick={fetchLogs}>🧾 대화 기록 보기</button>
      <ul>
        {logs.map((log) => (
          <li key={log.id}>
            <strong>Q:</strong> {log.question}<br/>
            <strong>A:</strong> {log.answer}<br/>
            <small>{new Date(log.created_at).toLocaleString()}</small>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default App;
```

---

## 📈 **추가 확장 아이디어**

| 주제           | 설명                                 |
| ------------ | ---------------------------------- |
| 📊 일별 대화량 통계 | SQL `GROUP BY DATE(created_at)`    |
| 🔍 검색 기능     | `WHERE question LIKE '%키워드%'`      |
| 🧠 벡터 저장     | 향후 “사용자 맥락 기억” 기능으로 확장             |
| 🧩 관리자 페이지   | `/admin/logs` 형태로 관리자가 대화 내용 열람 가능 |

---

## 🪞 **회고 템플릿**

> 🔹 내 AI가 대화를 저장하니 어떤 느낌이었는가?
> 🔹 SQLAlchemy나 DB 연결 중 어려웠던 점은?
> 🔹 “AI가 기억하는 기능”이 내 서비스에 어떤 의미를 줄까?
> 🔹 다음 주(6주차)에는 어떤 데이터 기반 개선을 해보고 싶은가?


