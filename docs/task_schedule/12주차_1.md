완벽한 타이밍이에요 👏
이제 **Week 12**는 “AI가 스스로 개선하는 단계”, 즉 **Feedback → Retrain → Improve** 루프를 만드는 시기예요.
그동안 만들어온 **AI 대화 로그 + 감정 분석 + 평가 데이터**를 기반으로
‘사용자 피드백’을 수집하고, 그걸 토대로 **AI 응답 품질을 자동으로 개선**하는 구조를 설계합니다.

---

# 🧭 **Week 12 — AI 피드백 루프 자동화 (Feedback → Retrain → Improve)**

> “이제 AI가 데이터를 모으고, 스스로 배우며, 응답 품질을 향상시키는 시스템으로 진화한다.”

---

## 🎯 **이번 주 목표**

* 사용자 피드백(좋아요/싫어요, 👍👎) 수집 기능 구현
* AI 응답 평가(`conversation_evaluation`) 테이블에 반영
* 벡터스토어 재임베딩(`vector_retrain.py`) 자동 트리거
* 주간 단위로 “AI 성능 변화 리포트” Slack 전송
* Streamlit Dashboard에 피드백 반영 지표 추가

---

## ⚙️ **핵심 구현 포인트**

| 구분              | 설명                                                       | 관련 파일                                                                  |
| --------------- | -------------------------------------------------------- | ---------------------------------------------------------------------- |
| 🗣 사용자 피드백 수집   | 대화 결과 화면에 👍👎 버튼 제공                                     | `frontend/src/components/ChatItem.vue` (또는 React 기준 `MessageCard.jsx`) |
| 🧠 DB 반영        | feedback_log 테이블 추가 (`feedback`, `reason`, `created_at`) | `app/models/feedback.py`                                               |
| 🔁 벡터 재학습 트리거   | 일정 비율 이상 부정 피드백 시 `vector_retrain.py` 자동 호출              | `app/utils/vector_retrain.py`                                          |
| 📊 피드백 리포트      | Slack으로 “이번 주 AI 만족도” 전송                                 | `app/utils/report_utils.py`                                            |
| 📈 Dashboard 반영 | 피드백 비율 및 개선 추세 시각화 탭 추가                                  | `dashboards/dashboard.py`                                              |

---

## 📁 **폴더 구조 (확장 버전)**

```
ai-career-6months/
 ┣ app/
 ┃ ┣ models/
 ┃ ┃ ┣ conversation_log.py
 ┃ ┃ ┣ evaluation_log.py
 ┃ ┃ ┗ feedback_log.py          👈 신규
 ┃ ┣ utils/
 ┃ ┃ ┣ vector_retrain.py
 ┃ ┃ ┣ report_utils.py
 ┃ ┃ ┗ slack_notifier.py
 ┃ ┣ routes/
 ┃ ┃ ┣ feedback.py              👈 신규 API (POST /feedback)
 ┃ ┃ ┗ evaluate.py
 ┣ dashboards/
 ┃ ┗ dashboard.py
 ┣ reports/
 ┗ backups/
```

---

## 🧩 **예시 코드 1 — Feedback API**

📄 `app/routes/feedback.py`

```python
from fastapi import APIRouter, HTTPException
from sqlalchemy import create_engine, text
import os, datetime

router = APIRouter()
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./local.db")
engine = create_engine(DATABASE_URL)

@router.post("/feedback")
def submit_feedback(data: dict):
    """
    사용자 피드백 저장 API
    - body: { conversation_id, feedback: 'like'|'dislike', reason: 'too slow'|'irrelevant' }
    """
    try:
        with engine.begin() as conn:
            conn.execute(text("""
                INSERT INTO feedback_log (conversation_id, feedback, reason, created_at)
                VALUES (:cid, :feedback, :reason, :created)
            """), {
                "cid": data.get("conversation_id"),
                "feedback": data.get("feedback"),
                "reason": data.get("reason"),
                "created": datetime.datetime.utcnow()
            })
        return {"status": "ok", "message": "Feedback recorded."}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

## 🧩 **예시 코드 2 — feedback_log 모델**

📄 `app/models/feedback_log.py`

```python
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.sql import func
from app.models.base import Base

class FeedbackLog(Base):
    __tablename__ = "feedback_log"

    id = Column(Integer, primary_key=True, index=True)
    conversation_id = Column(Integer, ForeignKey("conversation_log.id"))
    feedback = Column(String(10))  # 'like' or 'dislike'
    reason = Column(String(255))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

---

## 🧩 **예시 코드 3 — 벡터 재임베딩 자동 트리거**

📄 `app/utils/vector_retrain.py`

```python
from sqlalchemy import create_engine, text
import os

DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./local.db")
engine = create_engine(DATABASE_URL)

def retrain_if_needed(threshold=0.3):
    """
    피드백 데이터 기반 자동 재학습 트리거
    - 부정(feedback='dislike') 비율이 threshold 초과 시 재임베딩 수행
    """
    with engine.begin() as conn:
        result = conn.execute(text("""
            SELECT
                SUM(CASE WHEN feedback='dislike' THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS dislike_ratio
            FROM feedback_log
        """)).fetchone()

    dislike_ratio = result[0] or 0
    print(f"🧠 부정 피드백 비율: {dislike_ratio:.2f}")

    if dislike_ratio > threshold:
        print("🚀 부정 피드백이 높음 — 벡터 재임베딩 실행!")
        # 실제 재임베딩 로직 (예: documents → embeddings 업데이트)
        # ...
    else:
        print("✅ 피드백 비율 정상, 재학습 불필요.")
```

---

## 📊 **Slack 리포트 확장**

리포트에 피드백 통계 포함 👇
📄 `app/utils/report_utils.py`

```python
feedback_summary = conn.execute(text("""
    SELECT
      SUM(CASE WHEN feedback='like' THEN 1 ELSE 0 END) AS likes,
      SUM(CASE WHEN feedback='dislike' THEN 1 ELSE 0 END) AS dislikes
    FROM feedback_log
""")).fetchone()

message += f"\n🗳️ 피드백 요약: 👍 {feedback_summary.likes} / 👎 {feedback_summary.dislikes}"
```

---

## 📈 **Dashboard 확장 (dashboards/dashboard.py)**

새 탭 추가 👇

```python
tab4 = st.tab("🗳️ Feedback Analysis")

with tab4:
    st.header("사용자 피드백 분석")
    feedback_df = pd.read_sql("SELECT * FROM feedback_log", engine)
    st.bar_chart(feedback_df["feedback"].value_counts())
```

---

## ✅ **Week 12 Notion 체크리스트 + 코드 링크**

```
✅ Week 12 — AI 피드백 루프 자동화 (Feedback → Retrain → Improve)

🎯 목표
- 사용자 피드백 수집 및 DB 저장
- 부정 피드백 자동 감지 및 벡터 재학습
- Slack 리포트에 피드백 통계 추가
- Streamlit Dashboard 피드백 탭 추가

📅 작업 항목
- [ ] feedback_log 모델 생성
- [ ] /feedback API 구축
- [ ] feedback 기반 vector_retrain 로직 작성
- [ ] Slack 리포트에 피드백 통계 추가
- [ ] Dashboard Feedback 탭 추가

🧩 코드 링크
- [ ] app/models/feedback_log.py
- [ ] app/routes/feedback.py
- [ ] app/utils/vector_retrain.py
- [ ] app/utils/report_utils.py
- [ ] dashboards/dashboard.py

💡 확장 아이디어
- [ ] Feedback reason 클러스터링 (AI 불만 유형 자동 분석)
- [ ] 부정 피드백 → 자동 프롬프트 수정 루프 구축
- [ ] “AI 성능 개선 리포트” 주간 자동 Slack 전송
```

---

## 🧠 **한줄 요약**

> “Week 12는 AI가 스스로 피드백을 학습해 더 나은 대화로 진화하는 주차다.”
> — 이제 AI는 단순히 ‘답하는’ 것이 아니라, ‘성장하는 존재’가 된다. 🌱

---

원하신다면 ✨
이 Week 12 내용을 기반으로
**“Feedback → Retrain → Slack Report”**
세 단계를 자동 실행하는 **스케줄러 통합 버전 (`auto_feedback_loop.py`)** 도 만들어드릴까요?
(→ 매주 한 번 자동으로 “피드백 통계 → 재학습 → 리포트 전송” 수행)
