좋아요 🔥
이제 진짜 **배포 직전 “완전형 진단 스크립트”** 만들어드릴게요.
이 버전은 단순히 `.env`, DB, OpenAI Key만 확인하는 게 아니라,
👇 **실제 서비스 전체 상태를 미리 점검**합니다.

---

# 🧩 `deploy_preflight_check_pro.py`

📁 위치: `ai-career-6months/deploy_preflight_check_pro.py`

```python
"""
deploy_preflight_check_pro.py
-----------------------------
✅ Render + Neon + FastAPI 프로젝트용 완전형 배포 사전 점검 스크립트
- .env 환경파일 자동 감지 및 검증
- PostgreSQL (Neon) 연결 + ORM 모델 조회
- OpenAI API Key 유효성
- Chroma Vectorstore 접근성 및 컬렉션 개수 확인
- FastAPI 서버 포트/디렉토리 구조 점검
"""

import os
import sys
import psycopg2
from pathlib import Path
from dotenv import load_dotenv
from openai import OpenAI
from sqlalchemy import create_engine, inspect, text
from sqlalchemy.exc import SQLAlchemyError

# -------------------------------
# 1️⃣ 환경 파일 자동 감지
# -------------------------------
env_mode = os.getenv("ENV", "local")
env_file = ".env.prod" if env_mode == "production" else ".env.local"

if not Path(env_file).exists():
    print(f"❌ 환경 파일({env_file})을 찾을 수 없습니다.")
    sys.exit(1)

load_dotenv(env_file)
print(f"✅ 환경 파일 로드 완료: {env_file}")

# -------------------------------
# 2️⃣ 환경 변수 확인
# -------------------------------
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
DATABASE_URL = os.getenv("DATABASE_URL")
CHROMA_PATH = os.getenv("CHROMA_PATH", "./chroma_db")

errors = []

if not OPENAI_API_KEY:
    errors.append("❌ OPENAI_API_KEY 누락됨")
else:
    print("✅ OPENAI_API_KEY 존재함")

if not DATABASE_URL:
    errors.append("❌ DATABASE_URL 누락됨")
else:
    print("✅ DATABASE_URL 확인됨")

if errors:
    print("\n🚫 환경 변수 누락으로 점검 중단:")
    for e in errors:
        print(e)
    sys.exit(1)

# -------------------------------
# 3️⃣ PostgreSQL 연결 테스트
# -------------------------------
print("\n🔗 PostgreSQL(DB) 연결 테스트 중...")
try:
    conn = psycopg2.connect(DATABASE_URL)
    cur = conn.cursor()
    cur.execute("SELECT current_database(), current_user, version(), now();")
    db_info = cur.fetchone()
    print(f"✅ DB 연결 성공 → DB: {db_info[0]}, 사용자: {db_info[1]}")
    print(f"🕒 서버시간: {db_info[3]}")
    cur.close()
    conn.close()
except Exception as e:
    print("❌ DB 연결 실패:", e)
    sys.exit(1)

# -------------------------------
# 4️⃣ SQLAlchemy ORM 점검
# -------------------------------
print("\n🧱 SQLAlchemy ORM 점검 중...")
try:
    engine = create_engine(DATABASE_URL, connect_args={"sslmode": "require"})
    insp = inspect(engine)
    tables = insp.get_table_names()
    print(f"✅ ORM 연결 성공 — 총 {len(tables)}개 테이블 탐지됨:")
    for t in tables:
        print(f"   • {t}")

    # 기본 쿼리 테스트
    with engine.connect() as conn:
        result = conn.execute(text("SELECT NOW()")).scalar()
        print(f"🧩 SQL 실행 OK (NOW() → {result})")

except SQLAlchemyError as e:
    print("❌ SQLAlchemy 점검 실패:", e)
    sys.exit(1)

# -------------------------------
# 5️⃣ OpenAI API Key 테스트
# -------------------------------
print("\n🤖 OpenAI API Key 유효성 점검 중...")
try:
    client = OpenAI(api_key=OPENAI_API_KEY)
    models = client.models.list()
    print(f"✅ OpenAI Key 유효함 — 사용 가능 모델 {len(models.data)}개")
except Exception as e:
    print("❌ OpenAI Key 검증 실패:", e)
    sys.exit(1)

# -------------------------------
# 6️⃣ Chroma Vectorstore 점검
# -------------------------------
print("\n🧠 Chroma 벡터스토어 점검 중...")
try:
    from chromadb import PersistentClient
    client = PersistentClient(path=CHROMA_PATH)
    collections = client.list_collections()
    print(f"✅ Chroma DB 연결 성공 — 총 {len(collections)}개 컬렉션 발견")
    if collections:
        for c in collections:
            print(f"   • {c.name} (count: {c.count()})")
    else:
        print("⚠️ 현재 등록된 컬렉션 없음 (정상 상태일 수도 있음)")
except Exception as e:
    print("❌ Chroma 접근 실패:", e)

# -------------------------------
# 7️⃣ FastAPI 구조 점검
# -------------------------------
print("\n🧩 FastAPI 프로젝트 구조 점검 중...")
root = Path(__file__).parent
required_paths = [
    root / "app" / "main.py",
    root / "app" / "routers",
    root / "frontend" / "dist"
]
for path in required_paths:
    if path.exists():
        print(f"✅ {path} 존재 확인됨")
    else:
        print(f"⚠️ {path} 없음 — 배포 전 확인 필요")

# -------------------------------
# 8️⃣ 포트 충돌 점검
# -------------------------------
print("\n🌐 포트 사용 가능 여부 점검 중...")
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
result = sock.connect_ex(("127.0.0.1", 8000))
if result == 0:
    print("⚠️ 포트 8000이 이미 사용 중 (로컬에서 실행 중일 수 있음)")
else:
    print("✅ 포트 8000 사용 가능")
sock.close()

# -------------------------------
# 9️⃣ 요약 결과 출력
# -------------------------------
print("\n===============================")
print("🎯 DEPLOY PREFLIGHT CHECK 완료")
print("===============================")
print(f"환경: {env_mode.upper()}")
print(f"DB URL: {DATABASE_URL.split('@')[-1][:40]}...")
print(f"Chroma Path: {CHROMA_PATH}")
print("\n✅ 모든 핵심 구성 요소 점검 완료 — 배포해도 안전합니다 🚀")
```

---

## 🧠 주요 기능 요약

| 기능                    | 설명                                        |
| --------------------- | ----------------------------------------- |
| `.env` 자동 인식          | `ENV=production`이면 `.env.prod` 로드         |
| DB 연결 테스트             | psycopg2 → SQLAlchemy ORM 순서로 2단계 검사      |
| ORM 테이블 탐지            | 존재하는 테이블 목록 자동 출력                         |
| OpenAI API Key 확인     | `client.models.list()` 로 실시간 검증           |
| Chroma VectorStore 확인 | 현재 저장된 컬렉션 수/이름/count() 출력                |
| 디렉터리 구조 점검            | `/app/main.py`, `/frontend/dist` 존재 여부 체크 |
| 포트 충돌 감지              | 로컬 환경 포트 8000 사용 여부 검사                    |
| 결과 요약                 | “✅ Ready for Deploy 🚀” 메시지 출력            |

---

## ⚙️ 실행 방법

```bash
# Poetry 환경에서 실행
poetry run python deploy_preflight_check_pro.py
```

또는

```bash
python deploy_preflight_check_pro.py
```

---

## 📘 실행 예시 (정상 출력)

```
✅ 환경 파일 로드 완료: .env.prod
✅ OPENAI_API_KEY 존재함
✅ DATABASE_URL 확인됨

🔗 PostgreSQL(DB) 연결 테스트 중...
✅ DB 연결 성공 → DB: neondb, 사용자: neondb_owner
🕒 서버시간: 2025-10-14 11:58:23.42+00

🧱 SQLAlchemy ORM 점검 중...
✅ ORM 연결 성공 — 총 3개 테이블 탐지됨:
   • conversation_log
   • user_profile
   • chat_history
🧩 SQL 실행 OK (NOW() → 2025-10-14 11:58:23.42+00)

🤖 OpenAI API Key 유효성 점검 중...
✅ OpenAI Key 유효함 — 사용 가능 모델 62개

🧠 Chroma 벡터스토어 점검 중...
✅ Chroma DB 연결 성공 — 총 2개 컬렉션 발견
   • youth_policy_docs (count: 182)
   • chatbot_memory (count: 56)

🧩 FastAPI 프로젝트 구조 점검 중...
✅ /app/main.py 존재 확인됨
✅ /app/routers 존재 확인됨
✅ /frontend/dist 존재 확인됨

🌐 포트 사용 가능 여부 점검 중...
✅ 포트 8000 사용 가능

===============================
🎯 DEPLOY PREFLIGHT CHECK 완료
===============================
환경: PRODUCTION
DB URL: ep-calm-breeze-xxxxx.ap-southeast-1.aws.neon.tech...
Chroma Path: ./chroma_db

✅ 모든 핵심 구성 요소 점검 완료 — 배포해도 안전합니다 🚀
```

---

## ❌ 실패 시 예시 (즉시 중단)

```
❌ DB 연결 실패: FATAL: password authentication failed for user "neondb_owner"
```

→ → `.env.prod`의 `DATABASE_URL` 다시 확인.

---

## 💡 추가 팁

이 스크립트를 Render에서 실행하려면,

> Render Dashboard → Shell → “Run Command” 에서
> `poetry run python deploy_preflight_check_pro.py` 입력하면
> 실제 배포 환경에서 점검 가능합니다.

---

원하신다면 이 스크립트에
🧩 “자동 로그 저장 기능” (예: `/logs/deploy_check.log` 생성)
을 추가해, Render가 자동으로 결과를 파일로 남기도록 할 수도 있어요.
그 버전으로 확장해드릴까요?
