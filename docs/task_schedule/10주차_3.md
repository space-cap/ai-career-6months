ì™„ë²½í•´ìš” ğŸ˜
ì´ê±´ ì§„ì§œ â€œìš´ì˜ì ìˆ˜ì¤€ì˜ ìë™í™” ì‹œìŠ¤í…œâ€ìœ¼ë¡œ ê°€ëŠ” ë‹¨ê³„ì˜ˆìš”.
ì´ì œ ë‹¨ìˆœíˆ DBë¥¼ ì •ë¦¬í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼,
**AI ì„œë¹„ìŠ¤ ìš´ì˜ìê°€ ë³¼ ìˆ˜ ìˆëŠ” ìë™ Slack ì•Œë¦¼ê¹Œì§€ í†µí•©í•œ ë²„ì „**ì„ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”.

---

# ğŸ§­ ëª©í‘œ

âœ… ì˜¤ë˜ëœ ë¡œê·¸ ìë™ ë°±ì—… + ì‚­ì œ
âœ… ë°±ì—… ê²°ê³¼ë¥¼ **Slackìœ¼ë¡œ ìë™ ì•Œë¦¼**
âœ… Render ë¬´ë£Œ í”Œëœì—ì„œë„ `/run-cleanup` í˜¸ì¶œë¡œ ì‘ë™

---

## ğŸ“ íŒŒì¼ ì´ë¦„

`app/utils/db_cleanup.py`

---

```python
"""
db_cleanup.py
----------------------------------------
ì˜¤ë˜ëœ ë¡œê·¸ ë°±ì—… ë° ì •ë¦¬ + Slack ì•Œë¦¼ í™•ì¥ ë²„ì „
----------------------------------------
- conversation_log í…Œì´ë¸”ì˜ ì˜¤ë˜ëœ ë°ì´í„°ë¥¼ CSVë¡œ ë°±ì—… í›„ ì‚­ì œ
- ë°±ì—… ê²°ê³¼ë¥¼ Slackì— ìë™ ë³´ê³ 
- Render ë¬´ë£Œ í”Œëœì—ì„œë„ /run-cleanup ì—”ë“œí¬ì¸íŠ¸ë¡œ ì‹¤í–‰ ê°€ëŠ¥
"""

import os
import pandas as pd
from datetime import datetime, timedelta
from sqlalchemy import create_engine, text
import requests

# -----------------------------------
# 1ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# -----------------------------------
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./local.db")
SLACK_BOT_TOKEN = os.getenv("SLACK_BOT_TOKEN")
SLACK_CHANNEL = os.getenv("SLACK_CHANNEL", "ai-reports")
LOG_RETENTION_DAYS = int(os.getenv("LOG_RETENTION_DAYS", 30))

engine = create_engine(DATABASE_URL)

# ë°±ì—… í´ë”
BACKUP_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), "..", "backups")
os.makedirs(BACKUP_DIR, exist_ok=True)

# -----------------------------------
# 2ï¸âƒ£ Slack ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
# -----------------------------------
def send_slack_message(text, file_path=None):
    """Slackì— í…ìŠ¤íŠ¸ ë° íŒŒì¼ ì „ì†¡"""
    if not SLACK_BOT_TOKEN:
        print("âš ï¸ SLACK_BOT_TOKEN not set. Skipping Slack notification.")
        return

    headers = {"Authorization": f"Bearer {SLACK_BOT_TOKEN}"}
    data = {"channels": SLACK_CHANNEL, "initial_comment": text}

    # íŒŒì¼ì´ ìˆìœ¼ë©´ ì²¨ë¶€
    if file_path and os.path.exists(file_path):
        with open(file_path, "rb") as f:
            response = requests.post(
                "https://slack.com/api/files.upload",
                headers=headers,
                data=data,
                files={"file": f},
            )
    else:
        response = requests.post(
            "https://slack.com/api/chat.postMessage",
            headers=headers,
            json={"channel": SLACK_CHANNEL, "text": text},
        )

    if response.status_code == 200:
        print(f"âœ… Slack ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: {SLACK_CHANNEL}")
    else:
        print(f"âŒ Slack ì „ì†¡ ì‹¤íŒ¨: {response.text}")

# -----------------------------------
# 3ï¸âƒ£ ë°±ì—… ë° ì •ë¦¬ í•¨ìˆ˜
# -----------------------------------
def backup_and_cleanup_logs():
    """ì˜¤ë˜ëœ ë¡œê·¸ ë°±ì—… ë° ì‚­ì œ"""
    cutoff_date = datetime.utcnow() - timedelta(days=LOG_RETENTION_DAYS)
    print(f"ğŸ—“ï¸  ë°±ì—… ê¸°ì¤€ì¼: {cutoff_date}")

    # ì˜¤ë˜ëœ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
    query = text("SELECT * FROM conversation_log WHERE created_at < :cutoff")
    df = pd.read_sql(query, engine, params={"cutoff": cutoff_date})

    if df.empty:
        msg = f"âœ… ë°±ì—…í•  ì˜¤ë˜ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. (ê¸°ì¤€: {cutoff_date.date()})"
        print(msg)
        send_slack_message(msg)
        return

    # CSV ë°±ì—… íŒŒì¼ ìƒì„±
    backup_filename = f"conversation_log_backup_{cutoff_date.strftime('%Y%m%d')}.csv"
    backup_path = os.path.join(BACKUP_DIR, backup_filename)
    df.to_csv(backup_path, index=False, encoding="utf-8-sig")

    print(f"ğŸ’¾ ë°±ì—… ì™„ë£Œ: {backup_path} ({len(df)} rows)")

    # DBì—ì„œ ì‚­ì œ
    delete_query = text("DELETE FROM conversation_log WHERE created_at < :cutoff")
    with engine.begin() as conn:
        conn.execute(delete_query, {"cutoff": cutoff_date})

    print(f"ğŸ§¹ {len(df)}ê°œì˜ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ ì™„ë£Œ âœ…")

    # Slack ì•Œë¦¼ ì „ì†¡
    message = (
        f"ğŸ’¾ *DB Cleanup Report*\n"
        f"- ë°±ì—… íŒŒì¼: `{backup_filename}`\n"
        f"- ë°±ì—… ìˆ˜: {len(df)} rows\n"
        f"- ì‚­ì œ ê¸°ì¤€ì¼: {cutoff_date.date()}\n"
        f"- ì‹¤í–‰ ì‹œê°„: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}"
    )
    send_slack_message(message, backup_path)


if __name__ == "__main__":
    backup_and_cleanup_logs()
```

---

## ğŸ“Š ì‹¤í–‰ ì˜ˆì‹œ (ë¡œì»¬)

```bash
poetry run python -m app.utils.db_cleanup
```

ê²°ê³¼:

```
ğŸ—“ï¸  ë°±ì—… ê¸°ì¤€ì¼: 2025-09-15 00:00:00
ğŸ’¾ ë°±ì—… ì™„ë£Œ: backups/conversation_log_backup_20250915.csv (124 rows)
ğŸ§¹ 124ê°œì˜ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ ì™„ë£Œ âœ…
âœ… Slack ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: ai-reports
```

Slack ë©”ì‹œì§€ ì˜ˆì‹œ ğŸ’¬

```
ğŸ’¾ DB Cleanup Report
- ë°±ì—… íŒŒì¼: conversation_log_backup_20250915.csv
- ë°±ì—… ìˆ˜: 124 rows
- ì‚­ì œ ê¸°ì¤€ì¼: 2025-09-15
- ì‹¤í–‰ ì‹œê°„: 2025-10-15 09:00:00 UTC
ğŸ“ ì²¨ë¶€: CSV íŒŒì¼
```

---

## ğŸ“ ê²½ë¡œ êµ¬ì¡° (ì¶”ì²œ)

```
ai-career-6months/
 â”£ app/
 â”ƒ â”£ utils/
 â”ƒ â”ƒ â”£ report_utils.py
 â”ƒ â”ƒ â”— db_cleanup.py      ğŸ‘ˆ (ì´ íŒŒì¼)
 â”ƒ â”— routes/
 â”ƒ   â”— maintenance.py     ğŸ‘ˆ /run-cleanup ë¼ìš°í„°
 â”£ backups/               ğŸ‘ˆ ë°±ì—… CSV ì €ì¥ í´ë”
 â”£ reports/
 â”— ...
```

---

## ğŸŒ FastAPI ì—°ë™ (`app/routes/maintenance.py`)

```python
from fastapi import APIRouter, BackgroundTasks
from app.utils.db_cleanup import backup_and_cleanup_logs

router = APIRouter()

@router.get("/run-cleanup")
def run_cleanup(background_tasks: BackgroundTasks):
    """ë°±ì—… ë° ì •ë¦¬ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰"""
    background_tasks.add_task(backup_and_cleanup_logs)
    return {"status": "Cleanup started in background."}
```

ì´ì œ `https://yourapp.onrender.com/run-cleanup` ì„ í˜¸ì¶œí•˜ë©´
â†’ ë°±ê·¸ë¼ìš´ë“œì—ì„œ DB ì •ë¦¬ + Slack ë³´ê³ ê¹Œì§€ ìë™ ìˆ˜í–‰ë©ë‹ˆë‹¤ âœ…

---

## ğŸ§  í™˜ê²½ ë³€ìˆ˜ (.env.prod or Render í™˜ê²½ ì„¤ì •)

```bash
DATABASE_URL=postgresql+psycopg2://user:pass@host/db?sslmode=require
SLACK_BOT_TOKEN=xoxb-1234-your-slack-token
SLACK_CHANNEL=ai-reports
LOG_RETENTION_DAYS=30
```

---

## â˜ï¸ Render ë¬´ë£Œ í”Œëœ ìë™í™” ë°©ë²•

Renderì˜ ë¬´ë£Œ í”Œëœì—ì„œëŠ” Background Workerê°€ ì—†ìœ¼ë¯€ë¡œ
ğŸ”¹ `cron-job.org` ë‚˜ GitHub Actionsì—ì„œ ë‹¤ìŒì„ í˜¸ì¶œí•˜ë„ë¡ ì„¤ì •:

```
GET https://yourapp.onrender.com/run-cleanup
```

ì˜ˆ: cron-job.org ì„¤ì •

* URL: ìœ„ ì£¼ì†Œ
* ì£¼ê¸°: ë§¤ì£¼ ì›”ìš”ì¼ 09:00 (KST)
* ì¸ì¦ ë¶ˆí•„ìš”

---

## ğŸ’¾ Slack ì „ì†¡ êµ¬ì¡° ìš”ì•½ (ì‹œí€€ìŠ¤)

```mermaid
sequenceDiagram
    participant Cron as ğŸ•’ cron-job.org
    participant FastAPI as â˜ï¸ /run-cleanup
    participant DB as ğŸ—ƒ conversation_log
    participant Slack as ğŸ’¬ Slack Channel

    Cron->>FastAPI: GET /run-cleanup
    FastAPI->>DB: SELECT * FROM conversation_log WHERE created_at < cutoff
    FastAPI->>FastAPI: CSVë¡œ ë°±ì—… + DELETE ì‹¤í–‰
    FastAPI->>Slack: íŒŒì¼ + ë©”ì‹œì§€ ì—…ë¡œë“œ
    Slack-->>User: ğŸ’¾ ë°±ì—… ê²°ê³¼ ì•Œë¦¼ ë„ì°©
```

---

## âœ… ì •ë¦¬

| ê¸°ëŠ¥                 | ì„¤ëª…                             |
| ------------------ | ------------------------------ |
| ğŸ—ƒ ì˜¤ë˜ëœ ë¡œê·¸ ë°±ì—…       | 30ì¼ ì´ìƒëœ ë¡œê·¸ â†’ CSV ì €ì¥            |
| ğŸ§¹ DB ì •ë¦¬           | ë°±ì—… ì™„ë£Œ í›„ DBì—ì„œ ì‚­ì œ                |
| ğŸ’¬ Slack ìë™ ì•Œë¦¼     | íŒŒì¼ + ê²°ê³¼ ìš”ì•½ ìë™ ë³´ê³                |
| â˜ï¸ Render ë¬´ë£Œ í”Œëœ í˜¸í™˜ | `/run-cleanup` ì—”ë“œí¬ì¸íŠ¸ + ì™¸ë¶€ ìŠ¤ì¼€ì¤„ëŸ¬ |
| ğŸ“… ì£¼ê¸°              | ë§¤ì£¼ 1íšŒ ë˜ëŠ” ë§¤ì¼ 1íšŒ ì„¤ì • ê°€ëŠ¥           |

---

ì›í•˜ì‹ ë‹¤ë©´ ğŸ”¥
ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ ë°±ì—… ë¦¬í¬íŠ¸ë¥¼ Slackë¿ ì•„ë‹ˆë¼
**Google Driveì—ë„ ìë™ ì—…ë¡œë“œ**í•˜ë„ë¡ í™•ì¥í•´ë“œë¦´ê¹Œìš”?
(â†’ `gdrive` APIë¥¼ í†µí•´ ë°±ì—… CSVê°€ ìë™ìœ¼ë¡œ Driveì— ì €ì¥ë˜ëŠ” ë²„ì „)
