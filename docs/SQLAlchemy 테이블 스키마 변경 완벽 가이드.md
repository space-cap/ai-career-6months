<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# SQLAlchemy 테이블 스키마 변경 완벽 가이드

SQLAlchemy로 작성된 모델을 수정했을 때 데이터베이스 테이블을 변경하는 전체 과정을 단계별로 설명합니다.[^1][^2]

## 1. 사전 준비

### 1.1 필수 패키지 설치

**Poetry 사용하는 경우:**

```bash
poetry add alembic pymysql
```

**pip 사용하는 경우:**

```bash
pip install alembic pymysql
```


### 1.2 현재 프로젝트 구조 확인

프로젝트 구조가 다음과 같다고 가정합니다:[^3]

```
your_project/
├── app/
│   ├── __init__.py
│   ├── database.py      # Base와 engine 정의
│   └── models.py        # ConversationLog 모델
├── pyproject.toml
└── main.py
```


## 2. Alembic 초기화

### 2.1 Alembic 초기 설정

프로젝트 루트 디렉토리에서 실행합니다:[^2][^1]

```bash
alembic init alembic
```

이 명령어는 다음 파일들을 생성합니다:[^1][^3]

```
your_project/
├── alembic/
│   ├── versions/        # 마이그레이션 파일 저장 폴더
│   ├── env.py          # Alembic 환경 설정
│   └── script.py.mako  # 마이그레이션 템플릿
├── alembic.ini         # Alembic 설정 파일
└── (기존 파일들...)
```


## 3. Alembic 설정

### 3.1 데이터베이스 연결 설정 (alembic.ini)

`alembic.ini` 파일을 열고 데이터베이스 URL을 설정합니다:[^2]

```ini
# alembic.ini

# 기존 줄 찾기 (약 63번째 줄)
# sqlalchemy.url = driver://user:pass@localhost/dbname

# 다음으로 수정
sqlalchemy.url = mysql+pymysql://root:doolman@localhost:3306/ai_career
```

**중요:** 비밀번호가 특수문자를 포함하면 URL 인코딩이 필요할 수 있습니다.[^4]

### 3.2 모델 메타데이터 연결 (alembic/env.py)

`alembic/env.py` 파일을 열고 다음과 같이 수정합니다:[^5][^2]

**수정 전:**

```python
# alembic/env.py

# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
target_metadata = None
```

**수정 후:**

```python
# alembic/env.py

# 파일 상단에 import 추가 (약 7번째 줄 근처)
import sys
from pathlib import Path

# 프로젝트 루트를 Python 경로에 추가
sys.path.append(str(Path(__file__).resolve().parents[^1]))

# 모델 import
from app.database import Base
from app.models import ConversationLog  # 모든 모델을 import 해야 함

# target_metadata 설정 (약 21번째 줄 근처)
target_metadata = Base.metadata
```

**주의사항:**

- 모든 모델 클래스를 명시적으로 import해야 Alembic이 인식합니다[^6][^5]
- `Base.metadata`는 `app/database.py`에 정의된 SQLAlchemy Base 객체입니다[^2]


## 4. 모델 수정

### 4.1 기존 모델에 컬럼 추가

`app/models.py` 파일을 수정합니다:

```python
# app/models.py

from sqlalchemy import Column, Integer, String, Text, DateTime, func
from app.database import Base

class ConversationLog(Base):
    __tablename__ = "conversation_log"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(50), nullable=True)
    question = Column(Text, nullable=False)
    answer = Column(Text, nullable=False)
    sentiment = Column(String(20), nullable=True)  # ✅ 새로 추가
    topic = Column(String(100), nullable=True)     # ✅ 새로 추가
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```


## 5. 마이그레이션 생성

### 5.1 자동 마이그레이션 파일 생성

Alembic이 모델과 DB의 차이를 자동으로 감지하여 마이그레이션 파일을 생성합니다:[^5][^1]

```bash
alembic revision --autogenerate -m "Add sentiment and topic columns"
```

**명령어 설명:**

- `revision`: 새 마이그레이션 생성
- `--autogenerate`: 모델과 DB 스키마 차이를 자동 감지[^5]
- `-m "메시지"`: 마이그레이션 설명 메시지[^1]

**실행 결과:**

```
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added column 'conversation_log.sentiment'
INFO  [alembic.autogenerate.compare] Detected added column 'conversation_log.topic'
  Generating /path/to/your_project/alembic/versions/xxxxxxxxxxxx_add_sentiment_and_topic_columns.py ...  done
```


### 5.2 생성된 마이그레이션 파일 확인

`alembic/versions/` 폴더에 생성된 파일을 열어 확인합니다:[^1]

```python
# alembic/versions/xxxxxxxxxxxx_add_sentiment_and_topic_columns.py

"""Add sentiment and topic columns

Revision ID: xxxxxxxxxxxx
Revises: 
Create Date: 2025-10-13 03:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'xxxxxxxxxxxx'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('conversation_log', sa.Column('sentiment', sa.String(length=20), nullable=True))
    op.add_column('conversation_log', sa.Column('topic', sa.String(length=100), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('conversation_log', 'topic')
    op.drop_column('conversation_log', 'sentiment')
    # ### end Alembic commands ###
```

**주요 함수:**

- `upgrade()`: 스키마를 업그레이드할 때 실행되는 SQL 명령[^1]
- `downgrade()`: 롤백할 때 실행되는 SQL 명령[^1]


## 6. 마이그레이션 적용

### 6.1 데이터베이스에 적용

생성된 마이그레이션을 실제 데이터베이스에 적용합니다:[^2][^1]

```bash
alembic upgrade head
```

**실행 결과:**

```
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> xxxxxxxxxxxx, Add sentiment and topic columns
```

**명령어 설명:**

- `upgrade`: 마이그레이션 적용
- `head`: 최신 버전까지 업그레이드[^1]


### 6.2 적용 결과 확인

MySQL에 접속하여 테이블 구조를 확인합니다:

```sql
DESC conversation_log;
```

새로운 컬럼 `sentiment`와 `topic`이 추가되었는지 확인합니다.

## 7. 자주 사용하는 Alembic 명령어

### 7.1 현재 버전 확인

```bash
alembic current
```

현재 데이터베이스가 어느 마이그레이션 버전인지 확인합니다.[^1]

### 7.2 마이그레이션 히스토리 확인

```bash
alembic history
```

모든 마이그레이션 이력을 확인합니다.[^1]

### 7.3 특정 버전으로 이동

```bash
# 한 단계 다운그레이드
alembic downgrade -1

# 특정 revision으로 이동
alembic downgrade <revision_id>

# 모든 마이그레이션 취소
alembic downgrade base
```


### 7.4 수동 마이그레이션 파일 생성

자동 감지 없이 빈 마이그레이션 파일을 생성합니다:[^1]

```bash
alembic revision -m "manual changes"
```


## 8. 주의사항 및 Best Practices

### 8.1 중요 주의사항

**모델 import 필수**

- `alembic/env.py`에서 모든 모델을 명시적으로 import해야 합니다[^6]
- import하지 않은 모델은 autogenerate가 감지하지 못합니다[^5]

**기존 테이블 문제**

- `Base.metadata.create_all()`은 기존 테이블을 수정하지 않습니다[^3]
- 스키마 변경은 반드시 Alembic을 통해 해야 합니다[^2]

**데이터베이스 백업**

- 프로덕션 환경에서는 마이그레이션 전 반드시 백업합니다[^1]


### 8.2 Best Practices

**마이그레이션 파일 검토**

- `--autogenerate`로 생성된 파일은 반드시 검토합니다[^5]
- 자동 감지가 모든 변경사항을 완벽히 찾지 못할 수 있습니다[^5]

**의미 있는 메시지**

- `-m` 옵션으로 명확한 설명을 작성합니다[^1]
- 예: "Add sentiment and topic columns to conversation_log"

**버전 관리**

- 마이그레이션 파일을 Git에 커밋합니다[^1]
- 팀원 간 동일한 마이그레이션 상태를 유지합니다[^2]

**테스트 환경 먼저**

- 개발 환경에서 충분히 테스트 후 프로덕션에 적용합니다[^1]


## 9. 트러블슈팅

### 9.1 "No module named" 에러

```python
# alembic/env.py 상단에 추가
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).resolve().parents[^1]))
```


### 9.2 변경사항이 감지되지 않음

- 모델을 `alembic/env.py`에 import했는지 확인[^6]
- `target_metadata = Base.metadata` 설정 확인[^5]


### 9.3 데이터베이스 연결 실패

- `alembic.ini`의 `sqlalchemy.url` 확인[^2]
- 데이터베이스 서버 실행 상태 확인
- 계정 및 비밀번호 확인

***

이 가이드를 따라하면 SQLAlchemy 모델 변경사항을 안전하게 데이터베이스에 반영할 수 있습니다.[^7][^2][^1]
<span style="display:none">[^10][^11][^12][^13][^14][^15][^16][^17][^18][^19][^20][^8][^9]</span>

<div align="center">⁂</div>

[^1]: https://thinhdanggroup.github.io/alembic-python/

[^2]: https://dev.to/surajbhattarai/mastering-sqlalchemy-migrations-a-comprehensive-guide-2fo0

[^3]: https://www.kubeblogs.com/build-databases-with-sqlalchemy-and-alembic/

[^4]: https://alembic.sqlalchemy.org/en/latest/tutorial.html

[^5]: https://alembic.sqlalchemy.org/en/latest/autogenerate.html

[^6]: https://stackoverflow.com/questions/16076480/alembic-env-py-target-metadata-metadata-no-module-name-al-test-models

[^7]: https://testdriven.io/blog/alembic-database-migrations/

[^8]: https://www.youtube.com/watch?v=nt5sSr1A_qw

[^9]: https://dev.to/mchawa/sqlmodel-alembic-tutorial-gc8

[^10]: https://allan-simon.github.io/blog/posts/python-alembic-with-environment-variables/

[^11]: https://adex.ltd/database-migrations-with-alembic-and-fastapi-a-comprehensive-guide-using-poetry

[^12]: https://www.youtube.com/watch?v=TajZVh4heaM

[^13]: https://puddingcamp.com/page/c2231b62-2fd4-4df9-b79b-ae3995955e05

[^14]: https://www.chesnok.com/daily/2013/07/02/a-practical-guide-to-using-alembic/

[^15]: https://storyofvector7.tistory.com/80

[^16]: https://groups.google.com/g/sqlalchemy/c/zq1i45k2QMs

[^17]: https://www.oreilly.com/library/view/sqlalchemy-pilsu-gaideu/9798341655928/ch11.html

[^18]: https://codingdog.tistory.com/entry/fastapi-alembic-envpy에서-multiple-target-metadata를-인식하게-해-봅시다

[^19]: https://github.com/sqlalchemy/alembic

[^20]: https://engineer-mole.tistory.com/328

